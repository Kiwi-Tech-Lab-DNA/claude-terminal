#!/usr/bin/env amber

// Claude Desktop Replacement - Recent Conversations
// This script provides an interface for browsing and resuming recent Claude conversations
// Written in Amber for better readability and maintainability

import * from "std"

// Color definitions
let GREEN = "\033[0;32m"
let BLUE = "\033[0;34m"
let YELLOW = "\033[1;33m"
let RED = "\033[0;31m"
let NC = "\033[0m"

// Get script directory
fun get_script_dir(): Text {
    let result = $cd "$(dirname "${BASH_SOURCE[0]}")" && pwd$?
    return result as Text
}

// Function to display header
fun show_header() {
    $clear$?
    echo "{BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━{NC}"
    echo "{GREEN}                      📋 Recent Conversations{NC}"
    echo "{BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━{NC}"
    echo ""
}

// Function to show recent conversations using fzf
fun show_recents_fzf() {
    echo "{YELLOW}Loading recent conversations...{NC}"
    echo ""
    echo "This will show Claude's built-in conversation selector."
    echo "Use it to choose which conversation to resume."
    echo ""
    echo "{GREEN}Press Enter to continue, or Ctrl+C to return to menu...{NC}"
    input()

    let script_dir = get_script_dir()
    $cd "{script_dir}"$?

    // Try to run claude -r and handle potential issues
    if $claude -r$? != 0 {
        echo ""
        echo "{RED}Claude resume failed or no conversations found.{NC}"
        handle_error()
    }
}

// Function to show recent conversations with basic interface
fun show_recents_basic() {
    echo "{YELLOW}Recent Conversations{NC}"
    echo ""
    echo "This will launch Claude's built-in conversation browser."
    echo "You can browse and select from your recent conversations."
    echo ""
    echo "{GREEN}Options:{NC}"
    echo "  1) Browse recent conversations (claude -r)"
    echo "  2) Continue last conversation (claude -c)"
    echo "  3) Return to main menu"
    echo ""

    echo -n "Select an option (1-3): "
    let choice = input()

    let script_dir = get_script_dir()

    if choice == "1" {
        echo "{GREEN}Loading conversation browser...{NC}"
        $cd "{script_dir}"$?
        if $claude -r$? != 0 {
            echo ""
            echo "{RED}Claude resume failed or no conversations found.{NC}"
            handle_error()
        }

    } else if choice == "2" {
        echo "{GREEN}Continuing last conversation...{NC}"
        $cd "{script_dir}"$?
        if $claude -c$? != 0 {
            echo ""
            echo "{RED}No previous conversation found to continue.{NC}"
            handle_error()
        }

    } else if choice == "3" {
        $"{script_dir}/claude-menu.sh"$?

    } else {
        echo "{RED}Invalid option. Please try again.{NC}"
        $sleep 1$?
        show_recents_basic()
    }
}

// Function to handle errors gracefully
fun handle_error() {
    echo ""
    echo "{RED}Unable to load recent conversations.{NC}"
    echo ""
    echo "This might happen if:"
    echo "  • You haven't had any conversations with Claude yet"
    echo "  • Claude CLI is not properly configured"
    echo "  • There's a connectivity issue"
    echo "  • No previous conversations are available"
    echo ""
    echo "{YELLOW}Would you like to:{NC}"
    echo "  1) Try again"
    echo "  2) Start a new conversation instead"
    echo "  3) Return to main menu"
    echo ""

    loop {
        echo -n "Select an option (1-3): "
        let choice = input()

        if choice == "1" {
            main_recents()
            return

        } else if choice == "2" {
            echo "{GREEN}Starting new conversation...{NC}"
            let script_dir = get_script_dir()
            $cd "{script_dir}"$?
            $claude$?

        } else if choice == "3" {
            echo "{GREEN}Returning to main menu...{NC}"
            let script_dir = get_script_dir()
            $"{script_dir}/claude-menu.sh"$?

        } else {
            echo "{RED}Invalid option. Please enter 1, 2, or 3.{NC}"
        }
    }
}

// Main function
fun main_recents() {
    show_header()

    // Check if claude command is available
    if $command -v claude >/dev/null 2>&1$? != 0 {
        echo "{RED}Error: Claude CLI not found.{NC}"
        echo "Please make sure Claude CLI is installed and available in your PATH."
        echo ""
        echo "Press Enter to return to main menu..."
        input()
        let script_dir = get_script_dir()
        $"{script_dir}/claude-menu.sh"$?
        return
    }

    // Try to use the interface
    if $command -v fzf >/dev/null 2>&1$? == 0 {
        show_recents_fzf()
    } else {
        show_recents_basic()
    }
}

// Handle command line arguments
main {
    // Get command line argument (if any)
    let arg = if len(args) > 0 { args[0] } else { "" }

    if arg == "--help" or arg == "-h" {
        echo "Usage: $0 [options]"
        echo ""
        echo "Options:"
        echo "  --help, -h    Show this help message"
        echo ""
        echo "This script provides an interface for browsing and resuming"
        echo "recent Claude conversations using the claude -r command."
        exit(0)
    } else {
        main_recents()
    }
}